"use strict";(self.webpackChunkkywk_github_io=self.webpackChunkkywk_github_io||[]).push([[54416],{55492:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>a});var i=s(85893),r=s(11151);const l={title:"Ubuntu: NGINX + PHP",tags:["Infra","Linux/Ubuntu","NGINX","PHP"],date_created:new Date("2021-03-16T08:58:20.000Z"),image:"https://lh3.googleusercontent.com/pw/ACtC-3eEjuPzkzGlfvO-sUeB3BeuDd4MxMyUP2r4vJp53f2rK8p-vaRCNdC-UxOMDAQhANNfSTQr9fD4wJBSuDu3dXYIoMYDjaLJV6Np0KQZxnfY0VOm-JrNfVj_c0AjrP0jFEBKnJJrw8qAr8quoeHa5OuKJA=w750-h375-no?authuser=0"},c="[Ubuntu] \u5229\u7528 NGINX \u4f3a\u670d\u5668\u57f7\u884c PHP \u7a0b\u5f0f",t={id:"devsecops/infra/ubuntu_nginx-php",title:"Ubuntu: NGINX + PHP",description:"\u9577\u671f\u4ee5\u4f86 Apache Server \u7684\u6548\u80fd\u8207\u627f\u8f09\u6578\u4f4e\u843d, \u52a0\u4e0a\u5c64\u51fa\u4e0d\u7aae\u7684\u6f0f\u6d1e,",source:"@site/moco/devsecops/infra/ubuntu_nginx-php.md",sourceDirName:"devsecops/infra",slug:"/devsecops/infra/ubuntu_nginx-php",permalink:"/moco/devsecops/infra/ubuntu_nginx-php",draft:!1,unlisted:!1,tags:[{label:"Infra",permalink:"/moco/tags/infra"},{label:"Linux/Ubuntu",permalink:"/moco/tags/linux-ubuntu"},{label:"NGINX",permalink:"/moco/tags/nginx"},{label:"PHP",permalink:"/moco/tags/php"}],version:"current",frontMatter:{title:"Ubuntu: NGINX + PHP",tags:["Infra","Linux/Ubuntu","NGINX","PHP"],date_created:"2021-03-16T08:58:20.000Z",image:"https://lh3.googleusercontent.com/pw/ACtC-3eEjuPzkzGlfvO-sUeB3BeuDd4MxMyUP2r4vJp53f2rK8p-vaRCNdC-UxOMDAQhANNfSTQr9fD4wJBSuDu3dXYIoMYDjaLJV6Np0KQZxnfY0VOm-JrNfVj_c0AjrP0jFEBKnJJrw8qAr8quoeHa5OuKJA=w750-h375-no?authuser=0"},sidebar:"tutorialSidebar",previous:{title:"Redis: \u8b66\u544a\u8207\u554f\u984c\u6392\u9664",permalink:"/moco/devsecops/infra/redis_troubleshooting"},next:{title:"Security",permalink:"/moco/category/security"}},o={},a=[{value:"CGI",id:"cgi",level:3},{value:"FastCGI",id:"fastcgi",level:3},{value:"FPM(FastCGI Process Manager)",id:"fpmfastcgi-process-manager",level:3},{value:"Installation",id:"installation",level:2},{value:"Nginx",id:"nginx",level:3},{value:"PHP",id:"php",level:3},{value:"PHP-FPM",id:"php-fpm",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Nginx",id:"nginx-1",level:3},{value:"\u8a2d\u5b9a FPM",id:"\u8a2d\u5b9a-fpm",level:3},{value:"Start Nginx + PHP",id:"start-nginx--php",level:3},{value:"See Also",id:"see-also",level:2}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.a)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.h1,{id:"ubuntu-\u5229\u7528-nginx-\u4f3a\u670d\u5668\u57f7\u884c-php-\u7a0b\u5f0f",children:"[Ubuntu] \u5229\u7528 NGINX \u4f3a\u670d\u5668\u57f7\u884c PHP \u7a0b\u5f0f"}),"\n",(0,i.jsx)(e.p,{children:"\u9577\u671f\u4ee5\u4f86 Apache Server \u7684\u6548\u80fd\u8207\u627f\u8f09\u6578\u4f4e\u843d, \u52a0\u4e0a\u5c64\u51fa\u4e0d\u7aae\u7684\u6f0f\u6d1e,\n\u8a31\u591a\u4eba\u9678\u7e8c\u6295\u5411 Event-based Server \u7684\u61f7\u62b1, \u4f8b\u5982 Nginx."}),"\n",(0,i.jsx)(e.p,{children:"Nginx \u662f\u4e00\u500b\u514d\u8cbb\u958b\u6e90\u4e14\u7a69\u5b9a\u9ad8\u6548\u7684 Web \u4f3a\u670d\u5668\u7a0b\u5f0f, \u64c1\u6709\u53cd\u5411\u4ee3\u7406\u53ca\u8ca0\u8f09\u5e73\u8861\u7684\u529f\u80fd,\n\u85c9\u7531 Non-blocking \u8207 epool \u7684\u7279\u6027, \u5927\u5e45\u63d0\u6607\u4e86\u9023\u7dda\u670d\u52d9\u91cf\u8207\u901f\u5ea6, \u6210\u70ba\u8fd1\u5e74\u4f86\u6700\u70ba\u5ee3\u6cdb\u904b\u7528\u7684\u9078\u64c7."}),"\n",(0,i.jsx)(e.p,{children:"\u4f46\u662f Nginx \u53ea\u662f\u55ae\u7d14\u7684 HTTP Server, \u5982\u679c\u8981\u57f7\u884c\u7a0b\u5f0f, \u9084\u5f97\u85c9\u52a9 CGI \u7684\u5e6b\u5fd9.\nNginx \u53ef\u4ee5\u900f\u904e FastCGI \u53bb\u57f7\u884c PHP \u7a0b\u5f0f, \u4e14\u5167\u5efa FastCGI \u5feb\u53d6\u529f\u80fd.\n\u800c\u7b2c\u4e00\u6b65\u9700\u8981\u5be6\u73fe\u7684\u662f\u5982\u4f55\u8b93 Nginx \u6b63\u78ba\u7684\u547c\u53eb PHP."}),"\n",(0,i.jsx)(e.h3,{id:"cgi",children:"CGI"}),"\n",(0,i.jsx)(e.p,{children:"CGI (Common Gateway Interface) \u662f\u7528\u65bc\u7db2\u9801\u4f3a\u670d\u5668\u7684\u4ecb\u9762\u6a19\u6e96,\n\u652f\u63f4 CGI \u7684\u7db2\u9801\u4f3a\u670d\u5668\u6703\u5c07\u5176\u6240\u63a5\u6536\u5230\u7684 HTTP \u8acb\u6c42\u7684\u5167\u5bb9\u8a2d\u6210\u74b0\u5883\u8b8a\u6578,\n\u4f5c\u70ba\u67d0\u652f\u7a0b\u5f0f\u6642\u7684\u74b0\u5883\u8b8a\u6578\u4ee5\u53ca\u6a19\u6e96\u8f38\u5165 (stdin) \u8f38\u5165\u7684\u8cc7\u6599.\n\u800c\u8a72\u7a0b\u5f0f\u6a19\u6e96\u8f38\u51fa (stdout) \u7684\u8cc7\u6599\u5247\u6703\u88ab\u7db2\u9801\u4f3a\u670d\u5668\u62ff\u4f86\u56de\u61c9\u7d66\u5ba2\u6236\u7aef."}),"\n",(0,i.jsx)(e.p,{children:"\u7db2\u9801\u4f3a\u670d\u5668\u6bcf\u6b21\u4f7f\u7528 CGI \u57f7\u884c\u7a0b\u5f0f\u6642, \u90fd\u9700\u8981\u5efa\u7acb\u51fa\u65b0\u7684\u884c\u7a0b (fork process),\n\u5c31\u50cf\u5728\u7d42\u7aef\u6a5f\u76f4\u63a5\u7528\u6a94\u6848\u8def\u5f91\u53bb\u57f7\u884c\u67d0\u652f\u7a0b\u5f0f.\n\u53ef\u60f3\u800c\u77e5, \u9019\u6a23\u7684\u65b9\u5f0f\u5728\u61c9\u4ed8\u591a\u500b HTTP \u8acb\u6c42\u6642\u662f\u6c92\u6709\u6548\u7387\u7684\u3002"}),"\n",(0,i.jsx)(e.h3,{id:"fastcgi",children:"FastCGI"}),"\n",(0,i.jsx)(e.p,{children:"FastCGI \u5247\u662f\u5728\u7db2\u9801\u4f3a\u670d\u5668\u548c CGI\u7a0b\u5f0f\u4e4b\u9593\u518d\u52a0\u4e00\u500b\u7ba1\u7406\u54e1."}),"\n",(0,i.jsx)(e.p,{children:"\u7db2\u9801\u4f3a\u670d\u5668\u8981\u628a HTTP \u8acb\u6c42\u4ea4\u7d66\u7ba1\u7406\u54e1\u8655\u7406, \u7ba1\u7406\u54e1\u8ca0\u8cac\u5206\u914d CGI \u7a0b\u5f0f\u7684\u57f7\u884c\u8cc7\u6e90,\n\u4f7f\u7cfb\u7d71\u4e0d\u6703\u6bcf\u6b21\u9047\u5230\u8acb\u6c42\u5c31\u958b\u4e00\u500b\u884c\u7a0b\u53bb\u8dd1 CGI \u7a0b\u5f0f, \u4ee5\u6539\u5584\u904b\u4f5c\u6548\u7387."}),"\n",(0,i.jsx)(e.h3,{id:"fpmfastcgi-process-manager",children:"FPM(FastCGI Process Manager)"}),"\n",(0,i.jsx)(e.p,{children:"FPM(php-fpm) \u662f PHP \u76ee\u524d\u7684 FastCGI \u5be6\u4f5c."}),"\n",(0,i.jsx)(e.h2,{id:"installation",children:"Installation"}),"\n",(0,i.jsx)(e.h3,{id:"nginx",children:"Nginx"}),"\n",(0,i.jsxs)(e.p,{children:["\u5728 Ubuntu \u4e0a\u5b89\u88dd Nginx \u548c\u5b89\u88dd\u5176\u4ed6\u8edf\u9ad4\u4e00\u6a23, \u76f4\u63a5\u900f\u904e ",(0,i.jsx)(e.code,{children:"apt"})," \u5b89\u88dd\u5373\u53ef."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-shell",children:"$ sudo apt install nginx\n"})}),"\n",(0,i.jsx)(e.p,{children:"Nginx \u9810\u8a2d\u6703\u555f\u7528 HTTP, \u4f54\u7528 TCP \u9023\u63a5\u57e0\u70ba HTTP \u9810\u8a2d\u7684 80.\n\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u6307\u4ee4\u4f86\u67e5\u770b Nginx \u662f\u5426\u6709\u78ba\u5be6\u5b89\u88dd\u6210\u529f."}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-shell",children:"$ sudo netstat -tlnp | grep nginx\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.img,{src:"https://lh3.googleusercontent.com/pw/ACtC-3dV-nWgkfyACFUd4j0DDN0tmvWuOrhO8zprZsVWg7MbXfwzDYPOzYQtdvB0cqqPozf_-yzMW55AfkWGDc0sbFfm19rltX5FBkYcCP-qZ4T2JCl5auRbEaftoxXWyAKw5p4oIaCCGdpZGFuLr-vAcpO0Gg=w1214-h130-no?authuser=0",alt:""}),"\n\u5982\u4e0a\u5716, \u5982\u679c\u6709\u770b\u5230\u9023\u63a5\u57e0 80 \u6709\u88ab\u76e3\u807d, \u5c31\u8868\u793a Nginx \u5b89\u88dd\u6210\u529f."]}),"\n",(0,i.jsxs)(e.p,{children:["Nginx \u6240\u4ee5\u76e3\u807d\u4efb\u610f\u7db2\u8def\u4ecb\u9762\u4e0a\u7684 80 \u9023\u63a5\u57e0, \u662f\u56e0\u70ba\u9810\u8a2d\u7684\u8a2d\u5b9a\u6a94 ",(0,i.jsx)(e.code,{children:"(/etc/nginx/sites-available/default)"})," \u4e2d,\n\u6709\u8a2d\u4e00\u500b\u6703\u53bb\u76e3\u807d\u4efb\u610f\u7db2\u8def\u4ecb\u9762, \u4e14\u9023\u63a5\u57e0\u70ba 80 \u7684 ",(0,i.jsx)(e.strong,{children:"\u865b\u64ec\u4e3b\u6a5f (Virtual Host)"}),".\n\u6709\u95dc\u65bc Nginx \u9032\u4e00\u6b65\u7684\u8a2d\u5b9a\u8207\u914d\u7f6e\u8aaa\u660e, \u53ef\u4ee5\u53c3\u8003\n",(0,i.jsx)(e.a,{href:"https://magiclen.org/ubuntu-server-nginx/",children:"\u4f7f\u7528Ubuntu Server\u67b6\u8a2dNginx\u4f3a\u670d\u5668 | MagicLen"})]}),"\n",(0,i.jsx)(e.h3,{id:"php",children:"PHP"}),"\n",(0,i.jsx)(e.p,{children:"PHP \u662f\u8173\u672c\u5f0f\u7a0b\u5f0f\u8a9e\u8a00, \u9700\u8981\u6709 PHP \u57f7\u884c\u74b0\u5883\u624d\u53ef\u4ee5\u88ab\u57f7\u884c."}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-shell",children:"$ sudo apt install php-cli\n"})}),"\n",(0,i.jsxs)(e.p,{children:["\u5b89\u88dd\u5b8c ",(0,i.jsx)(e.code,{children:"php-cli"})," \u5957\u4ef6\u5f8c, \u53ef\u4ee5\u4f7f\u7528 ",(0,i.jsx)(e.code,{children:"php"})," \u6307\u4ee4\u4f86\u57f7\u884c PHP \u7a0b\u5f0f."]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u67e5\u770b PHP \u7684\u7248\u672c:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-shell",children:"$ php -v\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{src:"https://lh3.googleusercontent.com/pw/ACtC-3eYw_TsLcSEZ9pglabIbB0nJqs0KKJNq9y9qjjhZgWAAxpQ2LdxFH0eGKnc1Tjsr9h_0lDQhgYKvfGp0XSovF8ZsNVLA5IOJHWxZvjL1M_5YZWlbORRURJDRo7LkpWc-r9QB18sx9aYqDVEoF0Qms0jnQ=w802-h172-no?authuser=0",alt:""})}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsxs)(e.p,{children:["\u57f7\u884c PHP \u7a0b\u5f0f:\n",(0,i.jsx)(e.img,{src:"https://lh3.googleusercontent.com/pw/ACtC-3eOPeyqs8L6qvl7AxoPmInMY2pLWaoHAys9miug_nA6ACVhHqGbeHiBduAsPlWu_Rtb7iL-q4fM_2v25jmURV33rzqQvaxCRDHhshKE3RLSNlDAV8ESb4iy59NV7sbosIDFrpnSU7u3rHyNBK_Mktb50w=w784-h326-no?authuser=0",alt:""})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"php"})," \u8a2d\u5b9a\u6a94\u7684\u8def\u5f91\u662f ",(0,i.jsx)(e.code,{children:"/etc/php/<PHP\u7248\u672c\u865f\u78bc>/cli/php.ini"}),",\n\u8a73\u7d30\u8a2d\u5b9a\u8aaa\u660e\u53ef\u53c3\u8003\u5b98\u65b9\u6587\u4ef6\u6216 ",(0,i.jsx)(e.a,{href:"https://magiclen.org/ubuntu-server-nginx-php/",children:"\u4f7f\u7528Ubuntu Server\u900f\u904eNginx\u4f3a\u670d\u5668\u57f7\u884cPHP\u7a0b\u5f0f | MagicLen"}),"."]}),"\n",(0,i.jsx)(e.h3,{id:"php-fpm",children:"PHP-FPM"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-shell",children:"$ sudo apt install php-fpm\n"})}),"\n",(0,i.jsxs)(e.p,{children:["FPM \u9810\u8a2d\u53ea\u6703\u76e3\u807d Unix Domain Socket(UDS\uff0c\u6216\u7a31 IPC Socket), UDS \u6a94\u6848\u8def\u5f91\u70ba ",(0,i.jsx)(e.code,{children:"/run/php/php<PHP\u7248\u672c\u865f\u78bc>-fpm.sock"}),".\n\u4f8b\u5982 PHP 7.4 UDS \u6a94\u6848\u8def\u5f91\u5c31\u662f ",(0,i.jsx)(e.code,{children:"/run/php/php7.4-fpm.sock"}),"."]}),"\n",(0,i.jsxs)(e.p,{children:["\u5982\u679c\u8981\u78ba\u8a8d FPM \u6709\u6c92\u6709\u5b89\u88dd\u4e26\u555f\u7528\u6210\u529f, \u53ef\u4ee5\u5229\u7528 ",(0,i.jsx)(e.code,{children:"socat"})," \u9019\u500b\u6307\u4ee4\u5de5\u5177\u4f86\u9032\u884c.\n\u5b89\u88dd socat\uff1a"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-shell",children:"$ sudo apt install socat\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u57f7\u884c\u4ee5\u4e0b\u6307\u4ee4\u4f86\u5224\u65b7 FPM \u662f\u5426\u6b63\u5e38\u5de5\u4f5c:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-shell",children:'$ echo /dev/null | sudo socat unix:/var/run/php/php-fpm.sock - && echo "Working!" || echo "Not working!"\n'})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{src:"https://lh3.googleusercontent.com/pw/ACtC-3fQR-dRGQoBBDsbMbaJLBMuWu4qRTgsg6AVJaQ8nxsL1268iPR1UTrC3-4EhX8IQee8-v0rWO_ZAhvMja7kwfLB0UcnMwu24oRcChfdJ2FkzNWfe7vxR2p9EIZtf5c5WqaeD7X-PzxQGewrE7qp8A7bXw=w928-h128-no?authuser=0",alt:""})}),"\n",(0,i.jsx)(e.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsx)(e.h3,{id:"nginx-1",children:"Nginx"}),"\n",(0,i.jsx)(e.p,{children:"\u9806\u5229\u5b89\u88dd\u5b8c\u4e4b\u5f8c\u958b\u59cb\u4fee\u6539 Nginx Server \u8a2d\u5b9a\u6a94, \u5982\u4e0b:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-shell",children:"$ sudo vim /etc/nginx/nginx.conf\n"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"user www-data;\nworker_processes auto;\npid /run/nginx.pid;\ninclude /etc/nginx/modules-enabled/*.conf;\n\nevents {\n    use epoll;\n    worker_connections 2048;\n}\n\nhttp {\n    sendfile on;\n    tcp_nopush on;\n    tcp_nodelay on;\n    keepalive_timeout 65;\n    types_hash_max_size 2048;\n    server_tokens off;\n\n    include /etc/nginx/mime.types;\n    default_type application/octet-stream;\n\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE\n    ssl_prefer_server_ciphers on;\n\n    access_log /var/log/nginx/access.log;\n    error_log /var/log/nginx/error.log;\n\n    gzip on;\n\n    include /etc/nginx/conf.d/*.conf;\n    include /etc/nginx/sites-enabled/*;\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u5e7e\u500b\u91cd\u8981\u7684\u53c3\u6578:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"user"}),": Nginx Server \u555f\u52d5\u6240\u4f7f\u7528\u7684\u4f7f\u7528\u8005 (ubuntu \u9810\u8a2d\u7528 www-data)"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"pid"}),": ProcessID \u5b58\u653e\u4f4d\u7f6e ( ubuntu \u9810\u8a2d\u5728 /run/nginx.pid)"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"worker_processes"}),": \u958b\u555f\u7684\u7a0b\u5e8f\u6578\u91cf, \u8acb\u5c0d\u61c9 CPU \u6838\u5fc3\u6578\u9032\u884c\u8abf\u6574, \u6216\u7dad\u6301\u9810\u8a2d\u7684 auto"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"use epoll"}),": \u555f\u52d5 epoll \u6703\u5feb\u5f88\u591a\uff0c\u6548\u679c\u4e0d\u932f"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"worker_connections"}),": \u6bcf\u500b\u7a0b\u5e8f\u6700\u9ad8\u53ef\u4ee5\u958b\u555f\u7684\u9023\u7dda\u6578"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"server_tokens off"}),": \u79fb\u9664 Nginx \u7248\u672c\u8cc7\u8a0a"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"access_log, error_log"}),": HTTP Log \u5b58\u653e\u7684\u4f4d\u7f6e"]}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u4e0a\u9762\u662f Ngnix Server \u6574\u9ad4\u7684\u8a2d\u5b9a, \u63a5\u4e0b\u4f86\u8981\u9032\u884c Virtual Host \u914d\u7f6e."}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-shell",children:"$ sudo vim /etc/nginx/sites-available/default\n"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"server {\n    listen 80 default_server;\n    listen [::]:80 default_server;\n\n    root /var/www/html;\n\n    # Add index.php to the list if you are using PHP\n    index index.html index.htm index.php index.nginx-debian.html;\n\n    server_name _;\n\n    # set expiration of assets to MAX for caching\n    location ~* \\.(ico|css|js|gif|jpe?g|png|ogg|ogv|svg|svgz|eot|otf|woff)(\\?.+)?$ {\n        expires max;\n        log_not_found off;\n    }\n\n    # framework rewrite\n    location / {\n        try_files $uri $uri/ /index.php =404;\n    }\n\n    # pass PHP scripts to FastCGI server\n    location ~* \\.php$ {\n        #include snippets/fastcgi-php.conf;\n        fastcgi_pass 127.0.0.1:9000;\n        fastcgi_index index.php;\n        fastcgi_split_path_info ^(.+\\.php)(.*)$;\n        include fastcgi_params;\n        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n    }\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u5e7e\u500b\u53c3\u6578\u8a2d\u5b9a\u8aaa\u660e:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"server_name"}),": \u540c Apache ServerName \u53ef\u4ee5\u7528\u4f86\u6307\u5b9a Virtual Host (\u865b\u64ec\u4e3b\u6a5f)"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"root"}),": \u7db2\u9801\u6240\u64fa\u653e\u7684\u4f4d\u7f6e"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"location /"})," Selection (framework rewrite):\n\u7528 ",(0,i.jsx)(e.code,{children:"try_files $uri $uri/ /index.php;"})," \u4f86\u5617\u8a66\u8b80\u53d6\u958b\u555f.\n\u5982\u679c\u6a94\u6848\u4e0d\u5b58\u5728\u5c31\u8f49\u70ba\u547c\u53eb index.php.\n\u505a\u7684\u4e8b\u60c5\u8207\u5e38\u7528\u7684 Apache Rewrite Module \u5dee\u4e0d\u591a.\n\u4e3b\u8981\u662f\u70ba\u4e86\u5c07 Request \u5c0e\u7d66 Framework (\u5982 Codeigniter, Zend Framework \u7b49\u7b49),\n\u82e5\u6c92\u6709\u4f7f\u7528 PHP Framwwork, \u53ef\u4ee5\u7121\u9808\u8a2d\u5b9a."]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"location ~ .php$"})," Selection (pass PHP scripts to FastCGI server):\n\u8a2d\u5b9a\u8981\u5c07 ",(0,i.jsx)(e.code,{children:".php"})," \u6a94\u6848\u76f4\u63a5\u4ea4\u7531 FPM \u4f86\u8655\u7406.\n\u8a73\u7d30\u7684\u8a2d\u5b9a\u8aaa\u660e\u53ef\u4ee5\u53c3\u8003 ",(0,i.jsx)(e.a,{href:"https://www.nginx.com/resources/wiki/",children:"Nginx WIKI"}),".\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"fastcgi_pass"})," \u6307\u5411 PHP-FPM \u958b\u555f\u7684\u670d\u52d9\u4f4d\u7f6e, \u9700\u548c\u5f8c\u9762\u7684 PHP-FPM \u8a2d\u5b9a\u76f8\u540c,"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"\u8a2d\u5b9a-fpm",children:"\u8a2d\u5b9a FPM"}),"\n",(0,i.jsxs)(e.p,{children:["FPM \u8a2d\u5b9a\u6a94\u653e\u7f6e\u65bc ",(0,i.jsx)(e.code,{children:"/etc/php/<PHP\u7248\u672c\u865f\u78bc>/fpm/"})," \u76ee\u9304\u4e0b,\n\u4f8b\u5982 PHP 7.4 \u5c31\u662f\u5728 ",(0,i.jsx)(e.code,{children:"/etc/php/7.4/fpm/"})," \u76ee\u9304."]}),"\n",(0,i.jsxs)(e.p,{children:["FPM \u8a2d\u5b9a\u6a94\u76ee\u9304\u4e2d\u6709\u500b ",(0,i.jsx)(e.code,{children:"pool.d"})," \u76ee\u9304, \u7528\u4f86\u653e\u7f6e\u6bcf\u500b\u300c\u6c60\u300d (Pool) \u7684\u8a2d\u5b9a\u6a94.\n\u4e00\u500b\u6c60\u5c31\u662f\u4e00\u500b FastCGI \u7684\u7ba1\u7406\u5340\u57df (\u6216\u8005\u8aaa\u7ba1\u7406\u54e1).\n\u9810\u8a2d\u70ba ",(0,i.jsx)(e.code,{children:"www"})," \u6c60, \u8a2d\u5b9a\u6a94\u6a94\u540d\u70ba ",(0,i.jsx)(e.code,{children:"www.conf"}),":"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-shell",children:"$ sudo vim /etc/php/7.4/fpm/pool.d/www.conf\n"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-ini",children:"[www]\nuser = www-data\ngroup = www-data\n \nlisten = 127.0.0.1:9000\nlisten.backlog = 65535\nlisten.owner = www-data\nlisten.group = www-data\n \nrequest_terminate_timeout = 600s\n \npm = dynamic\npm.max_children = 5\npm.start_servers = 2\npm.min_spare_servers = 1\npm.max_spare_servers = 3\n"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"listen"}),": \u8a2d\u5b9a\u5f9e\u54ea\u500b\u5730\u65b9\u63a5\u6536 Nginx fastcgi_pass \u8acb\u6c42, \u8981\u548c\u524d\u9762 Nginx \u7684\u8a2d\u5b9a\u76f8\u540c.\n\u9810\u8a2d\u662f ",(0,i.jsx)(e.code,{children:"/run/php/php<PHP\u7248\u672c\u865f\u78bc>-fpm.sock"}),".\nPHP-FPM \u53ef\u4ee5\u900f\u904e TCP Socket \u6216\u8005\u662f UNIX Kernel Socket.\nKernel Socket \u901f\u5ea6\u6703\u6bd4\u8f03\u5feb, \u4f46\u662f\u7d93\u904e\u58d3\u529b\u6e2c\u8a66\u5f8c Kernel Socket \u53cd\u800c\u5e38\u5e38\u6389\u5305,\n\u7a69\u5b9a\u6027\u4e0d\u5982 TCP Socket \u4f86\u7684\u512a\u7570. \u6545\u9019\u908a\u8a2d\u70ba\u672c\u5730\u7aef\u7684 TCP Socket."]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"request_terminate_timeout"}),": \u8a2d\u5b9a\u8868\u793a PHP \u7684\u57f7\u884c\u6642\u9593, \u8d85\u904e\u9019\u500b\u9031\u671f\u5c31\u6703\u7d50\u675f.\n\u8a2d\u592a\u77ed\u5bb9\u6613\u9047\u5230\u6a94\u6848\u4e0a\u50b3\u6642\u9593\u6bd4\u8f03\u4e45\u5c31 GG \u4e86."]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"pm"}),": \u8a2d\u5b9a\u5b50\u884c\u7a0b\u7684\u6578\u91cf\u8981\u56fa\u5b9a\u9084\u662f\u6d6e\u52d5.\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"static \u662f\u56fa\u5b9a\u70ba\u6700\u5927\u6578\u91cf(pm.max_children)."}),"\n",(0,i.jsx)(e.li,{children:"dynamic \u662f\u52d5\u614b\u8abf\u6574, \u9810\u8a2d\u662f dynamic."}),"\n",(0,i.jsx)(e.li,{children:"ondemand \u662f\u884c\u7a0b\u958b\u5b8c\u5c31\u95dc."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"pm.max_children"}),": \u8a2d\u5b9a\u5b50\u884c\u7a0b\u7684\u6700\u5927\u6578\u91cf, \u9810\u8a2d\u662f5.\n\u9019\u500b\u6578\u91cf\u5efa\u8b70\u8a2d\u70ba\u8655\u7406\u5668\u7684\u6578\u91cf\u518d\u6839\u64da\u6bcf\u500b\u5b50\u884c\u7a0b\u7684\u8a18\u61b6\u9ad4\u7528\u91cf\u4e58\u4e0a\u67d0\u500b\u500d\u6578 (\u4f8b\u5982\u8a18\u61b6\u9ad4\u5269\u5f97\u5c11\u5c31\u4e582\uff0c\u8a18\u61b6\u9ad4\u5269\u5f97\u591a\u5c31\u4e584)."]}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"start-nginx--php",children:"Start Nginx + PHP"}),"\n",(0,i.jsx)(e.p,{children:"\u6700\u5f8c\u555f\u52d5 Nginx \u8207 PHP-FPM \u670d\u52d9:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-shell",children:"$ sudo service php7.4-fpm restart\n$ sudo service nginx restart\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u958b\u555f\u700f\u89bd\u5668\u8a66\u770b\u770b, Ubuntu \u88dd\u8d77\u4f86\u7684 Nginx Welcome \u756b\u9762\u5982\u4e0b\uff1a"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{src:"https://lh3.googleusercontent.com/pw/ACtC-3euV0DG5x_6NEszyLYrW1cW8cFj6p7qapfHbldw0am_PCAEX3lYENsxrPIBCA4gCCt37f-GBJv5Gs6138SYf8sf4l_wmKGbv1HbnmUH-q8uUWMHCnZ7cylYvCLxiXSwrzIgQ3K2EgX8Ido8J0jd0ZTbLw=w1088-h508-no?authuser=0",alt:""})}),"\n",(0,i.jsx)(e.h2,{id:"see-also",children:"See Also"}),"\n",(0,i.jsx)(e.p,{children:"\u6574\u9ad4\u4f86\u8aaa Nginx \u5b89\u88dd\u883b\u5bb9\u6613\u7684, \u4f46\u8981\u8abf\u6821\u7684\u597d\u53c8\u662f\u53e6\u5916\u4e00\u4ef6\u4e8b.\n\u8a2d\u5b9a\u7684\u4e0d\u6d3d\u7576, \u5728\u9ad8\u6d41\u91cf\u6642 Nginx \u5e38\u6703\u9001\u4f60 502 Bad Gateway."}),"\n",(0,i.jsx)(e.p,{children:"\u53c8\u4f8b\u5982 Nginx \u53ef\u4ee5\u5c07 FastCGI \u670d\u52d9\u56de\u61c9\u7684\u8cc7\u6599\u5feb\u53d6\u6210\u6a94\u6848,\n\u9019\u6a23\u4e0b\u6b21\u5982\u679c\u53c8\u6709\u4e00\u6a23\u7684\u8acb\u6c42\uff0cNginx \u5c31\u76f4\u63a5\u5f9e\u6a94\u6848\u7cfb\u7d71\u4e2d\u6488\u51fa\u4f86\u56de\u61c9\uff0c\n\u4e0d\u5fc5\u518d\u8f49\u9001\u7d66 FastCGI \u670d\u52d9\u8655\u7406, \u53ef\u52a0\u5feb\u53cd\u61c9.\nCache \u7684\u8a2d\u7f6e\u76f8\u7576\u8003\u9a57 SRE \u5c0d PHP \u670d\u52d9\u4e86\u89e3\u7a0b\u5ea6, \u4e26\u975e\u6240\u6709\u670d\u52d9\u90fd\u9069\u5408\u958b\u8a2d Cache.\n\u9019\u53e6\u7bc7\u518d\u8a0e\u8ad6\u4e86."}),"\n",(0,i.jsx)(e.p,{children:"\u9700\u8981\u82b1\u883b\u591a\u6642\u9593\u5617\u8a66\u8abf\u6574\u53c3\u6578, \u642d\u914d\u6548\u80fd\u6e2c\u8a66\u5de5\u5177\u4f86\u6aa2\u67e5, \u8b93\u4f3a\u670d\u5668\u767c\u63ee\u6700\u5927\u6548\u7528."}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://magiclen.org/ubuntu-server-nginx-php/",children:"\u4f7f\u7528Ubuntu Server\u900f\u904eNginx\u4f3a\u670d\u5668\u57f7\u884cPHP\u7a0b\u5f0f | MagicLen"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://blog.toright.com/posts/3890/%E7%84%A1%E5%A0%85%E4%B8%8D%E6%91%A7%EF%BC%8C%E5%94%AF%E5%BF%AB%E4%B8%8D%E7%A0%B4%EF%BC%81%E5%BF%AB%E6%94%B9%E7%94%A8-nginx-php-fpm-%E5%8F%96%E4%BB%A3-apache-%E5%90%A7%EF%BC%81.html",children:"\u7121\u5805\u4e0d\u6467\uff0c\u552f\u5feb\u4e0d\u7834\uff01\u5feb\u6539\u7528 Nginx + PHP-FPM \u53d6\u4ee3 Apache \u5427\uff01 - Soul & Shell Blog"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"https://xenby.com/b/137-%E6%95%99%E5%AD%B8-%E5%AE%89%E8%A3%9Dlemplinuxnginxmysqlphp%E7%92%B0%E5%A2%83",children:"[\u6559\u5b78] \u5b89\u88ddLEMP(Linux+Nginx+Mysql+PHP)\u74b0\u5883 | \u8f9b\u6bd4\u8a8c"})}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,r.a)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(d,{...n})}):d(n)}},11151:(n,e,s)=>{s.d(e,{Z:()=>t,a:()=>c});var i=s(67294);const r={},l=i.createContext(r);function c(n){const e=i.useContext(l);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:c(n.components),i.createElement(l.Provider,{value:e},n.children)}}}]);