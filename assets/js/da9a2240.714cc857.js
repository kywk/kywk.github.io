"use strict";(self.webpackChunkkywk_me=self.webpackChunkkywk_me||[]).push([["86637"],{5261:function(e,n,r){r.r(n),r.d(n,{frontMatter:()=>d,toc:()=>s,default:()=>f,metadata:()=>t,assets:()=>c,contentTitle:()=>o});var t=JSON.parse('{"id":"Golang/A Tour of Go/Go Tour Defer","title":"defar","description":"defar","source":"@site/moco/Golang/A Tour of Go/Go Tour Defer.md","sourceDirName":"Golang/A Tour of Go","slug":"/golang/a-tour-of-go/go-tour-defer/","permalink":"/moco/golang/a-tour-of-go/go-tour-defer/","draft":false,"unlisted":false,"tags":[{"inline":true,"label":"Go","permalink":"/moco/tags/go"},{"inline":true,"label":"Go/GoTour","permalink":"/moco/tags/go-go-tour"}],"version":"current","frontMatter":{"title":"defar","description":"defar","tags":["Go","Go/GoTour"],"date_created":"2022-04-11T12:08:41.000Z","image":"https://lh3.googleusercontent.com/pw/AM-JKLWu8wVpy5iA1V-YEeQHafjhEuZiS8kFPaPu0pj_m6yi09YtCsVYFT8Z6LxtDL57sWDXa8rRZm6B_OsIhWjgBWupJ1ZopYhtDR5PMn-4q8ypuliQvh5KDBfdZmKAxOkIXb4FhRvkuQsRhKiyjB02tR6otw=w860-h480-no?authuser=0s","slug":"/golang/a-tour-of-go/go-tour-defer/"},"sidebar":"tutorialSidebar","previous":{"title":"Closure","permalink":"/moco/golang/a-tour-of-go/go-tour-closure/"},"next":{"title":"Goroutine","permalink":"/moco/golang/a-tour-of-go/go-tour-goroutine/"}}'),i=r(74848),l=r(84429);let d={title:"defar",description:"defar",tags:["Go","Go/GoTour"],date_created:new Date("2022-04-11T12:08:41.000Z"),image:"https://lh3.googleusercontent.com/pw/AM-JKLWu8wVpy5iA1V-YEeQHafjhEuZiS8kFPaPu0pj_m6yi09YtCsVYFT8Z6LxtDL57sWDXa8rRZm6B_OsIhWjgBWupJ1ZopYhtDR5PMn-4q8ypuliQvh5KDBfdZmKAxOkIXb4FhRvkuQsRhKiyjB02tR6otw=w860-h480-no?authuser=0s",slug:"/golang/a-tour-of-go/go-tour-defer/"},o="[Go] Tour: defar \u5FC3\u5F97\u7B46\u8A18",c={},s=[{value:"\u57F7\u884C\u9806\u5E8F",id:"\u57F7\u884C\u9806\u5E8F",level:2},{value:"defer \u751F\u6548\u9806\u5E8F",id:"defer-\u751F\u6548\u9806\u5E8F",level:3},{value:"defer/return \u9806\u5E8F\u8207\u56DE\u50B3\u503C",id:"deferreturn-\u9806\u5E8F\u8207\u56DE\u50B3\u503C",level:3},{value:"pointer",id:"pointer",level:4},{value:"named return",id:"named-return",level:4},{value:"defer \u5B9A\u7FA9\u548C\u57F7\u884C",id:"defer-\u5B9A\u7FA9\u548C\u57F7\u884C",level:3},{value:"\u5E38\u898B\u4F7F\u7528\u5834\u666F",id:"\u5E38\u898B\u4F7F\u7528\u5834\u666F",level:2},{value:"\u91CB\u653E\u5360\u7528\u7684\u8CC7\u6E90",id:"\u91CB\u653E\u5360\u7528\u7684\u8CC7\u6E90",level:3},{value:"\u6355\u6349\u8655\u7406\u7570\u5E38",id:"\u6355\u6349\u8655\u7406\u7570\u5E38",level:3},{value:"\u8F38\u51FA\u65E5\u5FD7 \u7B49\u6536\u5C3E\u5DE5\u4F5C",id:"\u8F38\u51FA\u65E5\u5FD7-\u7B49\u6536\u5C3E\u5DE5\u4F5C",level:3},{value:"\u5E38\u898B\u932F\u8AA4",id:"\u5E38\u898B\u932F\u8AA4",level:2},{value:"See Also",id:"see-also",level:2}];function u(e){let n={a:"a",blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"go-tour-defar-\u5FC3\u5F97\u7B46\u8A18",children:"[Go] Tour: defar \u5FC3\u5F97\u7B46\u8A18"})}),"\n",(0,i.jsx)(n.p,{children:"defer \u662F golang \u7684\u4E00\u500B\u7279\u8272\u529F\u80FD, \u5728 A Tour of Go \u88E1\u7684\u8AAA\u660E\u5982\u4E0B:"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"Defer\nA defer statement defers the execution of a function until the surrounding function returns. The deferred call's arguments are evaluated immediately, but the function call is not executed until the surrounding function returns."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u4E4B\u524D\u5728 defer \u4F7F\u7528\u4E0A, \u4E3B\u8981\u662F\u7528\u51FD\u6578\u7D50\u675F\u524D\u9032\u884C ",(0,i.jsx)(n.code,{children:"io.Close"})," \u4E4B\u985E\u7684\u5FC5\u8981\u7D50\u675F\u52D5\u4F5C.\n\u6216\u662F\u66FF\u4EE3\u5176\u4ED6\u8A9E\u8A00\u4E2D ",(0,i.jsx)(n.code,{children:"try\u2026 catch \u2026 finally\u2026"})," \u7684 ",(0,i.jsx)(n.code,{children:"finally"}),".\n\u4ED4\u7D30\u4E86\u89E3\u5F8C\u624D\u767C\u73FE defer \u7684\u4E00\u4E9B\u7279\u6027, \u4F7F\u7528\u4E0A\u8A72\u591A\u6CE8\u610F."]}),"\n",(0,i.jsx)(n.h2,{id:"\u57F7\u884C\u9806\u5E8F",children:"\u57F7\u884C\u9806\u5E8F"}),"\n",(0,i.jsx)(n.h3,{id:"defer-\u751F\u6548\u9806\u5E8F",children:"defer \u751F\u6548\u9806\u5E8F"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"defer \u57F7\u884C\u9806\u5E8F\u662F\u5148\u9032\u5F8C\u51FA"}),", \u5982\u4E0B:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func main() {\n    for i := 0; i < 5; i++ {\n        defer fmt.Printf("%d\\n", i)\n    }\n}\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"4\n3\n2\n1\n0\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u82E5\u900F\u904E defer \u547C\u53EB\u8655\u7406\u7684\u51FD\u6578\u6709\u9806\u5E8F\u95DC\u4FC2, \u4F7F\u7528\u4E0A\u9700\u6CE8\u610F\u5BE6\u969B\u57F7\u884C\u9806\u5E8F."}),"\n",(0,i.jsx)(n.h3,{id:"deferreturn-\u9806\u5E8F\u8207\u56DE\u50B3\u503C",children:"defer/return \u9806\u5E8F\u8207\u56DE\u50B3\u503C"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u5148\u5C07 return \u7D50\u679C\u5BEB\u5165\u8FD4\u56DE\u503C\u4E2D -> \u63A5\u8457\u4F9D\u5E8F\u57F7\u884C defer \u5DE5\u4F5C -> \u6700\u5F8C\u51FD\u6578\u651C\u5E36\u8FD4\u56DE\u503C\u9000\u51FA"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func deferFunc() int {\n    fmt.Println("defer func called")\n    return 0\n}\n\nfunc returnFunc() int {\n    fmt.Println("return func called")\n    return 0\n}\n\nfunc returnAndDefer() int {\n    defer deferFunc()\n    return returnFunc()\n}\n\nfunc main() {\n    returnAndDefer()\n}\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"eturn func called\ndefer func called\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u55AE\u8A0E\u8AD6\u57F7\u884C\u9806\u5E8F\u7684\u8A71, defer func \u5728 return \u4E4B\u5F8C\u57F7\u884C.",(0,i.jsx)(n.br,{}),"\n\u4F46\u82E5\u8A0E\u8AD6\u5230\u56DE\u50B3\u503C\u7684\u8A71, defer func \u53EF\u80FD\u6703\u5F71\u97FF\u7A0B\u5F0F\u56DE\u50B3\u7D50\u679C, \u4F7F\u7528\u4E0A\u9700\u6CE8\u610F."]}),"\n",(0,i.jsx)(n.h4,{id:"pointer",children:"pointer"}),"\n",(0,i.jsx)(n.p,{children:"\u6700\u76F4\u89BA\u7684, return pointer \u72C0\u6CC1\u4E0B, \u82E5 defer func \u6703\u66F4\u6539 pointer \u7269\u4EF6\u5167\u5BB9,\n\u5247\u8A72\u7269\u4EF6\u6700\u7D42\u7D50\u679C\u6703\u662F defer func \u57F7\u884C\u5F8C\u7684\u72C0\u614B."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type Test struct {\n    Value int\n}\n\nfunc deferFunc(t *Test) {\n    t.Value++\n}\n\nfunc testFunc(i int) *Test {\n    result := Test{}\n    defer deferFunc(&result)\n    result.Value = i\n    return &result\n}\n\nfunc main() {\n    r := testFunc(5)\n    fmt.Println(r.Value)\n}\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"6\n"})}),"\n",(0,i.jsx)(n.h4,{id:"named-return",children:"named return"}),"\n",(0,i.jsxs)(n.p,{children:["\u8FD4\u56DE\u503C\u7684\u8868\u9054\u65B9\u5F0F, \u6211\u5011\u77E5\u9053\u6839\u64DA\u662F\u5426\u63D0\u524D\u8072\u660E\u6709\u5169\u7A2E\u65B9\u5F0F:\n\u4E00\u7A2E\u662F ",(0,i.jsx)(n.code,{children:"func test() int"})," \u53E6\u4E00\u7A2E\u662F ",(0,i.jsx)(n.code,{children:"func test() (i int)"})," ,\n\u5169\u7A2E\u60C5\u6CC1\u90FD\u4F86\u8AAA\u8AAA:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func main() {\n    fmt.Println("main:", test())\n}\nfunc test() int {\n    var i int\n    defer func() {\n        i++\n        fmt.Println("defer2\u7684\u503C:", i)\n    }()\n    defer func() {\n        i++\n        fmt.Println("defer1\u7684\u503C:", i)\n    }()\n    return i\n}\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"defer1\u7684\u503C: 1\ndefer2\u7684\u503C: 2\nmain: 0\n"})}),"\n",(0,i.jsxs)(n.p,{children:["return \u6642\u5DF2\u7D93\u5148\u5C07\u8FD4\u56DE\u503C\u7D66\u8A18\u9304\u4E0B\u4F86\u70BA 0.",(0,i.jsx)(n.br,{}),"\n\u7531\u65BC i \u51FD\u6578\u5167\u90E8\u8072\u660E, \u5373\u4F7F defer \u51FD\u5F0F\u66F4\u6539, \u4E5F\u4E0D\u6703\u5F71\u97FF return \u7684\u6578\u503C."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func main() {\n    fmt.Println("main:", test())\n}\nfunc test() (i int) {\n    defer func() {\n        i++\n        fmt.Println("defer2\u7684\u503C:", i)\n    }()\n    defer func() {\n        i++\n        fmt.Println("defer1\u7684\u503C:", i)\n    }()\n    return i\n}\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"defer1\u7684\u503C: 1\ndefer2\u7684\u503C: 2\nmain: 2\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u8FD4\u56DE\u7684 i \u5728\u51FD\u5F0F\u5BA3\u544A\u6642\u5B9A\u7FA9, \u5247 defer \u5C0D i \u9032\u884C\u7684\u64CD\u4F5C\u6703\u5F71\u97FF\u6700\u7D42 i \u7684\u503C."}),"\n",(0,i.jsx)(n.h3,{id:"defer-\u5B9A\u7FA9\u548C\u57F7\u884C",children:"defer \u5B9A\u7FA9\u548C\u57F7\u884C"}),"\n",(0,i.jsxs)(n.p,{children:["defer \u6240\u57F7\u884C\u7684\u6307\u4EE4\u6216\u51FD\u5F0F, \u6703\u5148\u628A\u53C3\u6578\u90E8\u5206\u7684\u503C\u78BA\u5B9A\u4E0B\u4F86, \u4E4B\u5F8C\u4E0D\u6703\u6539\u8B8A.",(0,i.jsx)(n.br,{}),"\n\u7B49\u5F85\u51FD\u5F0F\u57F7\u884C\u7D50\u675F, \u624D\u5C07\u4E4B\u524D\u5B9A\u7FA9\u7684\u53C3\u6578\u6578\u503C\u5E36\u5165\u908F\u8F2F\u57F7\u884C."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func test(i *int) int {\n    return *i\n}\nfunc main() {\n    var i = 1\n    // \u5BA3\u544A defer \u7684\u6642\u5019\uFF0C\u6703\u5148\u78BA\u8A8D test(&i) \u7684\u503C\u70BA 1\uFF0C\u5F8C\u9762\u4E0D\u6703\u6539\u8B8A\n    defer fmt.Println("i1 =", test(&i))\n    i++\n    // \u540C\u4E0A\uFF0C\u6B64\u6642 test(&i) \u7684\u503C\u662F2\uFF0C\u5F8C\u9762\u4E0D\u6703\u8B8A\n    defer fmt.Println("i2 =", test(&i))\n    // \u5B9A\u7FA9 defer \u7684\u6642\u5019\uFF0Ci \u662F\u4E00\u500B\u6307\u91DD\u985E\u578B\uFF0C\u5730\u5740\u4E0A\u7684\u503C\u66F4\u52D5\uFF0C\u9019\u88E1\u8DDF\u8457\u8B8A\n    defer func(i *int) {\n        fmt.Println("i3 =", *i)\n    }(&i)\n    // \u5BA3\u544A defer \u6642\uFF0Ci \u7684\u503C\u662F2\uFF0C\u5F8C\u9762\u4E0D\u6703\u6539\u8B8A\n    defer func(i int) {\n        fmt.Println("i4 =", i)\n    }(i)\n    defer func() {\n        // \u5730\u5740\uFF0C\u6240\u4EE5\u5F8C\u7E8C\u8DDF\u8457\u8B8A\n        var c = &i\n        fmt.Println("i5 =", *c)\n    }()\n    // \u57F7\u884C i=11 \u5F8C\u624D\u8ABF\u7528\uFF0C\u6B64\u6642 i \u503C\u5DF2\u662F11\n    defer func() {\n        fmt.Println("i6 =", i)\n    }()\n    i = 11\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\u5E38\u898B\u4F7F\u7528\u5834\u666F",children:"\u5E38\u898B\u4F7F\u7528\u5834\u666F"}),"\n",(0,i.jsx)(n.h3,{id:"\u91CB\u653E\u5360\u7528\u7684\u8CC7\u6E90",children:"\u91CB\u653E\u5360\u7528\u7684\u8CC7\u6E90"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func test() error {\n    file, err := os.Open("path")\n    if err != nil {\n        return err\n    }\n    // \u653E\u5728\u5224\u65B7 err \u72C0\u614B\u4E4B\u5F8C\n    defer file.Close()\n\n    //...\n    return nil\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u6355\u6349\u8655\u7406\u7570\u5E38",children:"\u6355\u6349\u8655\u7406\u7570\u5E38"}),"\n",(0,i.jsx)(n.p,{children:"\u6355\u6349\u932F\u8AA4\u7684 defer \u901A\u5E38\u6703\u6700\u5148\u5BA3\u544A, \u4EE5\u78BA\u4FDD\u57F7\u884C\u9806\u5E8F\u70BA\u6700\u5F8C\u88AB\u547C\u53EB."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func test2() {\n    defer func() {\n        if err := recover(); err != nil {\n            fmt.Println(err)\n        }\n    }()\n    file, err := os.Open("path")\n    if err != nil {\n        panic(err)\n    }\n    defer file.Close()\n\n    //...\n    return\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u8F38\u51FA\u65E5\u5FD7-\u7B49\u6536\u5C3E\u5DE5\u4F5C",children:"\u8F38\u51FA\u65E5\u5FD7 \u7B49\u6536\u5C3E\u5DE5\u4F5C"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func test3() {\n    t1 := time.Now()\n    defer func() {\n        fmt.Printf("\u8017\u6642: %f s", time.Now().Sub(t1).Seconds())\n    }()\n\n    //...\n    return\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\u5E38\u898B\u932F\u8AA4",children:"\u5E38\u898B\u932F\u8AA4"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func test4() error {\n    f, err := os.Open("A.txt")\n    if err != nil {\n        return err\n    }\n    defer func() { f.Close() }()//\u932F\u8AA4: \u95DC\u9589\u662FB\u6587\u4EF6,f\u5F15\u7528\u88AB\u91CD\u65B0\u8CE6\u503C\n    f, err = os.Open("B.txt")\n    if err != nil {\n        return err\n    }\n    defer func() { f.Close() }() //\u95DC\u9589\u662FB\u6587\u4EF6\n    list := []int{1, 2}\n    for _, i := range list {\n        defer fmt.Println(i) //\u8F38\u51FA 2 1 //i\u70BA\u503C\u985E\u578B\u53C3\u6578\u88AB\u5FA9\u5236\n        defer func() { fmt.Println(i) }() //\u932F\u8AA4: \u8F38\u51FA 2 2 //\u51FD\u6578\u9AD4\u5167\u5C0Di\u5F15\u7528,\u7559\u6700\u7D42\u503C\n    }\n    return nil\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://go.dev/blog/defer-panic-and-recover",children:"Defer, Panic, and Recover - The Go Blog"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://walkonnet.com/archives/56570",children:"Golang \u7684defer\u57F7\u884C\u898F\u5247\u8AAA\u660E - WalkonNet"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://www.gushiciku.cn/pl/pQWu/zh-tw",children:"Golang\u4E2D\u7684Defer\u5FC5\u638C\u63E1\u76847\u77E5\u8B58\u9EDE - MdEditor"})}),"\n"]})]})}function f(e={}){let{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},84429:function(e,n,r){r.d(n,{R:()=>d,x:()=>o});var t=r(96540);let i={},l=t.createContext(i);function d(e){let n=t.useContext(l);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);