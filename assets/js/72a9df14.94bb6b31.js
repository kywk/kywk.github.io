"use strict";(self.webpackChunkblog_kywk=self.webpackChunkblog_kywk||[]).push([[14675],{3905:(e,n,r)=>{r.d(n,{Zo:()=>c,kt:()=>s});var t=r(67294);function l(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function a(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function i(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?a(Object(r),!0).forEach((function(n){l(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function o(e,n){if(null==e)return{};var r,t,l=function(e,n){if(null==e)return{};var r,t,l={},a=Object.keys(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||(l[r]=e[r]);return l}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(t=0;t<a.length;t++)r=a[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(l[r]=e[r])}return l}var u=t.createContext({}),f=function(e){var n=t.useContext(u),r=n;return e&&(r="function"==typeof e?e(n):i(i({},n),e)),r},c=function(e){var n=f(e.components);return t.createElement(u.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},p=t.forwardRef((function(e,n){var r=e.components,l=e.mdxType,a=e.originalType,u=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),p=f(r),s=l,m=p["".concat(u,".").concat(s)]||p[s]||d[s]||a;return r?t.createElement(m,i(i({ref:n},c),{},{components:r})):t.createElement(m,i({ref:n},c))}));function s(e,n){var r=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var a=r.length,i=new Array(a);i[0]=p;var o={};for(var u in n)hasOwnProperty.call(n,u)&&(o[u]=n[u]);o.originalType=e,o.mdxType="string"==typeof e?e:l,i[1]=o;for(var f=2;f<a;f++)i[f]=r[f];return t.createElement.apply(null,i)}return t.createElement.apply(null,r)}p.displayName="MDXCreateElement"},72147:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>u,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>o,toc:()=>f});var t=r(87462),l=(r(67294),r(3905));const a={title:"defar",description:"defar",tags:["Go","go-tour"],date:new Date("2022-04-11T12:08:41.000Z"),image:"https://lh3.googleusercontent.com/pw/AM-JKLWu8wVpy5iA1V-YEeQHafjhEuZiS8kFPaPu0pj_m6yi09YtCsVYFT8Z6LxtDL57sWDXa8rRZm6B_OsIhWjgBWupJ1ZopYhtDR5PMn-4q8ypuliQvh5KDBfdZmKAxOkIXb4FhRvkuQsRhKiyjB02tR6otw=w860-h480-no?authuser=0s"},i="[Go] Tour: defar \u5fc3\u5f97\u7b46\u8a18",o={unversionedId:"golang/go-tour/go-tour_defer",id:"golang/go-tour/go-tour_defer",title:"defar",description:"defar",source:"@site/blogging/moco/golang/go-tour/go-tour_defer.md",sourceDirName:"golang/go-tour",slug:"/golang/go-tour/go-tour_defer",permalink:"/moco/golang/go-tour/go-tour_defer",draft:!1,tags:[{label:"Go",permalink:"/moco/tags/go"},{label:"go-tour",permalink:"/moco/tags/go-tour"}],version:"current",frontMatter:{title:"defar",description:"defar",tags:["Go","go-tour"],date:"2022-04-11T12:08:41.000Z",image:"https://lh3.googleusercontent.com/pw/AM-JKLWu8wVpy5iA1V-YEeQHafjhEuZiS8kFPaPu0pj_m6yi09YtCsVYFT8Z6LxtDL57sWDXa8rRZm6B_OsIhWjgBWupJ1ZopYhtDR5PMn-4q8ypuliQvh5KDBfdZmKAxOkIXb4FhRvkuQsRhKiyjB02tR6otw=w860-h480-no?authuser=0s"},sidebar:"tutorialSidebar",previous:{title:"Closure",permalink:"/moco/golang/go-tour/go-tour_closure"},next:{title:"Goroutine",permalink:"/moco/golang/go-tour/go-tour_goroutine"}},u={},f=[{value:"\u57f7\u884c\u9806\u5e8f",id:"\u57f7\u884c\u9806\u5e8f",level:2},{value:"defer \u751f\u6548\u9806\u5e8f",id:"defer-\u751f\u6548\u9806\u5e8f",level:3},{value:"defer/return \u9806\u5e8f\u8207\u56de\u50b3\u503c",id:"deferreturn-\u9806\u5e8f\u8207\u56de\u50b3\u503c",level:3},{value:"pointer",id:"pointer",level:4},{value:"named return",id:"named-return",level:4},{value:"defer \u5b9a\u7fa9\u548c\u57f7\u884c",id:"defer-\u5b9a\u7fa9\u548c\u57f7\u884c",level:3},{value:"\u5e38\u898b\u4f7f\u7528\u5834\u666f",id:"\u5e38\u898b\u4f7f\u7528\u5834\u666f",level:2},{value:"\u91cb\u653e\u5360\u7528\u7684\u8cc7\u6e90",id:"\u91cb\u653e\u5360\u7528\u7684\u8cc7\u6e90",level:3},{value:"\u6355\u6349\u8655\u7406\u7570\u5e38",id:"\u6355\u6349\u8655\u7406\u7570\u5e38",level:3},{value:"\u8f38\u51fa\u65e5\u5fd7 \u7b49\u6536\u5c3e\u5de5\u4f5c",id:"\u8f38\u51fa\u65e5\u5fd7-\u7b49\u6536\u5c3e\u5de5\u4f5c",level:3},{value:"\u5e38\u898b\u932f\u8aa4",id:"\u5e38\u898b\u932f\u8aa4",level:2},{value:"See Also",id:"see-also",level:2}],c={toc:f};function d(e){let{components:n,...r}=e;return(0,l.kt)("wrapper",(0,t.Z)({},c,r,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"go-tour-defar-\u5fc3\u5f97\u7b46\u8a18"},"[Go]"," Tour: defar \u5fc3\u5f97\u7b46\u8a18"),(0,l.kt)("p",null,"defer \u662f golang \u7684\u4e00\u500b\u7279\u8272\u529f\u80fd, \u5728 A Tour of Go \u88e1\u7684\u8aaa\u660e\u5982\u4e0b:"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"Defer\nA defer statement defers the execution of a function until the surrounding function returns. The deferred call's arguments are evaluated immediately, but the function call is not executed until the surrounding function returns.")),(0,l.kt)("p",null,"\u4e4b\u524d\u5728 defer \u4f7f\u7528\u4e0a, \u4e3b\u8981\u662f\u7528\u51fd\u6578\u7d50\u675f\u524d\u9032\u884c ",(0,l.kt)("inlineCode",{parentName:"p"},"io.Close")," \u4e4b\u985e\u7684\u5fc5\u8981\u7d50\u675f\u52d5\u4f5c.\n\u6216\u662f\u66ff\u4ee3\u5176\u4ed6\u8a9e\u8a00\u4e2d ",(0,l.kt)("inlineCode",{parentName:"p"},"try\u2026 catch \u2026 finally\u2026")," \u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"finally"),".\n\u4ed4\u7d30\u4e86\u89e3\u5f8c\u624d\u767c\u73fe defer \u7684\u4e00\u4e9b\u7279\u6027, \u4f7f\u7528\u4e0a\u8a72\u591a\u6ce8\u610f."),(0,l.kt)("h2",{id:"\u57f7\u884c\u9806\u5e8f"},"\u57f7\u884c\u9806\u5e8f"),(0,l.kt)("h3",{id:"defer-\u751f\u6548\u9806\u5e8f"},"defer \u751f\u6548\u9806\u5e8f"),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"defer \u57f7\u884c\u9806\u5e8f\u662f\u5148\u9032\u5f8c\u51fa"),", \u5982\u4e0b:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func main() {\n    for i := 0; i < 5; i++ {\n        defer fmt.Printf("%d\\n", i)\n    }\n}\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"4\n3\n2\n1\n0\n")),(0,l.kt)("p",null,"\u82e5\u900f\u904e defer \u547c\u53eb\u8655\u7406\u7684\u51fd\u6578\u6709\u9806\u5e8f\u95dc\u4fc2, \u4f7f\u7528\u4e0a\u9700\u6ce8\u610f\u5be6\u969b\u57f7\u884c\u9806\u5e8f."),(0,l.kt)("h3",{id:"deferreturn-\u9806\u5e8f\u8207\u56de\u50b3\u503c"},"defer/return \u9806\u5e8f\u8207\u56de\u50b3\u503c"),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"\u5148\u5c07 return \u7d50\u679c\u5beb\u5165\u8fd4\u56de\u503c\u4e2d -> \u63a5\u8457\u4f9d\u5e8f\u57f7\u884c defer \u5de5\u4f5c -> \u6700\u5f8c\u51fd\u6578\u651c\u5e36\u8fd4\u56de\u503c\u9000\u51fa")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func deferFunc() int {\n    fmt.Println("defer func called")\n    return 0\n}\n\nfunc returnFunc() int {\n    fmt.Println("return func called")\n    return 0\n}\n\nfunc returnAndDefer() int {\n    defer deferFunc()\n    return returnFunc()\n}\n\nfunc main() {\n    returnAndDefer()\n}\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"eturn func called\ndefer func called\n")),(0,l.kt)("p",null,"\u55ae\u8a0e\u8ad6\u57f7\u884c\u9806\u5e8f\u7684\u8a71, defer func \u5728 return \u4e4b\u5f8c\u57f7\u884c.",(0,l.kt)("br",{parentName:"p"}),"\n","\u4f46\u82e5\u8a0e\u8ad6\u5230\u56de\u50b3\u503c\u7684\u8a71, defer func \u53ef\u80fd\u6703\u5f71\u97ff\u7a0b\u5f0f\u56de\u50b3\u7d50\u679c, \u4f7f\u7528\u4e0a\u9700\u6ce8\u610f."),(0,l.kt)("h4",{id:"pointer"},"pointer"),(0,l.kt)("p",null,"\u6700\u76f4\u89ba\u7684, return pointer \u72c0\u6cc1\u4e0b, \u82e5 defer func \u6703\u66f4\u6539 pointer \u7269\u4ef6\u5167\u5bb9,\n\u5247\u8a72\u7269\u4ef6\u6700\u7d42\u7d50\u679c\u6703\u662f defer func \u57f7\u884c\u5f8c\u7684\u72c0\u614b."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},"type Test struct {\n    Value int\n}\n\nfunc deferFunc(t *Test) {\n    t.Value++\n}\n\nfunc testFunc(i int) *Test {\n    result := Test{}\n    defer deferFunc(&result)\n    result.Value = i\n    return &result\n}\n\nfunc main() {\n    r := testFunc(5)\n    fmt.Println(r.Value)\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"6\n")),(0,l.kt)("h4",{id:"named-return"},"named return"),(0,l.kt)("p",null,"\u8fd4\u56de\u503c\u7684\u8868\u9054\u65b9\u5f0f, \u6211\u5011\u77e5\u9053\u6839\u64da\u662f\u5426\u63d0\u524d\u8072\u660e\u6709\u5169\u7a2e\u65b9\u5f0f:\n\u4e00\u7a2e\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"func test() int")," \u53e6\u4e00\u7a2e\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"func test() (i int)")," ,\n\u5169\u7a2e\u60c5\u6cc1\u90fd\u4f86\u8aaa\u8aaa:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func main() {\n    fmt.Println("main:", test())\n}\nfunc test() int {\n    var i int\n    defer func() {\n        i++\n        fmt.Println("defer2\u7684\u503c:", i)\n    }()\n    defer func() {\n        i++\n        fmt.Println("defer1\u7684\u503c:", i)\n    }()\n    return i\n}\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"defer1\u7684\u503c: 1\ndefer2\u7684\u503c: 2\nmain: 0\n")),(0,l.kt)("p",null,"return \u6642\u5df2\u7d93\u5148\u5c07\u8fd4\u56de\u503c\u7d66\u8a18\u9304\u4e0b\u4f86\u70ba 0.",(0,l.kt)("br",{parentName:"p"}),"\n","\u7531\u65bc i \u51fd\u6578\u5167\u90e8\u8072\u660e, \u5373\u4f7f defer \u51fd\u5f0f\u66f4\u6539, \u4e5f\u4e0d\u6703\u5f71\u97ff return \u7684\u6578\u503c."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func main() {\n    fmt.Println("main:", test())\n}\nfunc test() (i int) {\n    defer func() {\n        i++\n        fmt.Println("defer2\u7684\u503c:", i)\n    }()\n    defer func() {\n        i++\n        fmt.Println("defer1\u7684\u503c:", i)\n    }()\n    return i\n}\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"defer1\u7684\u503c: 1\ndefer2\u7684\u503c: 2\nmain: 2\n")),(0,l.kt)("p",null,"\u8fd4\u56de\u7684 i \u5728\u51fd\u5f0f\u5ba3\u544a\u6642\u5b9a\u7fa9, \u5247 defer \u5c0d i \u9032\u884c\u7684\u64cd\u4f5c\u6703\u5f71\u97ff\u6700\u7d42 i \u7684\u503c."),(0,l.kt)("h3",{id:"defer-\u5b9a\u7fa9\u548c\u57f7\u884c"},"defer \u5b9a\u7fa9\u548c\u57f7\u884c"),(0,l.kt)("p",null,"defer \u6240\u57f7\u884c\u7684\u6307\u4ee4\u6216\u51fd\u5f0f, \u6703\u5148\u628a\u53c3\u6578\u90e8\u5206\u7684\u503c\u78ba\u5b9a\u4e0b\u4f86, \u4e4b\u5f8c\u4e0d\u6703\u6539\u8b8a.",(0,l.kt)("br",{parentName:"p"}),"\n","\u7b49\u5f85\u51fd\u5f0f\u57f7\u884c\u7d50\u675f, \u624d\u5c07\u4e4b\u524d\u5b9a\u7fa9\u7684\u53c3\u6578\u6578\u503c\u5e36\u5165\u908f\u8f2f\u57f7\u884c."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func test(i *int) int {\n    return *i\n}\nfunc main() {\n    var i = 1\n    // \u5ba3\u544a defer \u7684\u6642\u5019\uff0c\u6703\u5148\u78ba\u8a8d test(&i) \u7684\u503c\u70ba 1\uff0c\u5f8c\u9762\u4e0d\u6703\u6539\u8b8a\n    defer fmt.Println("i1 =", test(&i))\n    i++\n    // \u540c\u4e0a\uff0c\u6b64\u6642 test(&i) \u7684\u503c\u662f2\uff0c\u5f8c\u9762\u4e0d\u6703\u8b8a\n    defer fmt.Println("i2 =", test(&i))\n    // \u5b9a\u7fa9 defer \u7684\u6642\u5019\uff0ci \u662f\u4e00\u500b\u6307\u91dd\u985e\u578b\uff0c\u5730\u5740\u4e0a\u7684\u503c\u66f4\u52d5\uff0c\u9019\u88e1\u8ddf\u8457\u8b8a\n    defer func(i *int) {\n        fmt.Println("i3 =", *i)\n    }(&i)\n    // \u5ba3\u544a defer \u6642\uff0ci \u7684\u503c\u662f2\uff0c\u5f8c\u9762\u4e0d\u6703\u6539\u8b8a\n    defer func(i int) {\n        fmt.Println("i4 =", i)\n    }(i)\n    defer func() {\n        // \u5730\u5740\uff0c\u6240\u4ee5\u5f8c\u7e8c\u8ddf\u8457\u8b8a\n        var c = &i\n        fmt.Println("i5 =", *c)\n    }()\n    // \u57f7\u884c i=11 \u5f8c\u624d\u8abf\u7528\uff0c\u6b64\u6642 i \u503c\u5df2\u662f11\n    defer func() {\n        fmt.Println("i6 =", i)\n    }()\n    i = 11\n}\n')),(0,l.kt)("h2",{id:"\u5e38\u898b\u4f7f\u7528\u5834\u666f"},"\u5e38\u898b\u4f7f\u7528\u5834\u666f"),(0,l.kt)("h3",{id:"\u91cb\u653e\u5360\u7528\u7684\u8cc7\u6e90"},"\u91cb\u653e\u5360\u7528\u7684\u8cc7\u6e90"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func test() error {\n    file, err := os.Open("path")\n    if err != nil {\n        return err\n    }\n    // \u653e\u5728\u5224\u65b7 err \u72c0\u614b\u4e4b\u5f8c\n    defer file.Close()\n\n    //...\n    return nil\n}\n')),(0,l.kt)("h3",{id:"\u6355\u6349\u8655\u7406\u7570\u5e38"},"\u6355\u6349\u8655\u7406\u7570\u5e38"),(0,l.kt)("p",null,"\u6355\u6349\u932f\u8aa4\u7684 defer \u901a\u5e38\u6703\u6700\u5148\u5ba3\u544a, \u4ee5\u78ba\u4fdd\u57f7\u884c\u9806\u5e8f\u70ba\u6700\u5f8c\u88ab\u547c\u53eb."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func test2() {\n    defer func() {\n        if err := recover(); err != nil {\n            fmt.Println(err)\n        }\n    }()\n    file, err := os.Open("path")\n    if err != nil {\n        panic(err)\n    }\n    defer file.Close()\n\n    //...\n    return\n}\n')),(0,l.kt)("h3",{id:"\u8f38\u51fa\u65e5\u5fd7-\u7b49\u6536\u5c3e\u5de5\u4f5c"},"\u8f38\u51fa\u65e5\u5fd7 \u7b49\u6536\u5c3e\u5de5\u4f5c"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func test3() {\n    t1 := time.Now()\n    defer func() {\n        fmt.Printf("\u8017\u6642: %f s", time.Now().Sub(t1).Seconds())\n    }()\n\n    //...\n    return\n}\n')),(0,l.kt)("h2",{id:"\u5e38\u898b\u932f\u8aa4"},"\u5e38\u898b\u932f\u8aa4"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func test4() error {\n    f, err := os.Open("A.txt")\n    if err != nil {\n        return err\n    }\n    defer func() { f.Close() }()//\u932f\u8aa4: \u95dc\u9589\u662fB\u6587\u4ef6,f\u5f15\u7528\u88ab\u91cd\u65b0\u8ce6\u503c\n    f, err = os.Open("B.txt")\n    if err != nil {\n        return err\n    }\n    defer func() { f.Close() }() //\u95dc\u9589\u662fB\u6587\u4ef6\n    list := []int{1, 2}\n    for _, i := range list {\n        defer fmt.Println(i) //\u8f38\u51fa 2 1 //i\u70ba\u503c\u985e\u578b\u53c3\u6578\u88ab\u5fa9\u5236\n        defer func() { fmt.Println(i) }() //\u932f\u8aa4: \u8f38\u51fa 2 2 //\u51fd\u6578\u9ad4\u5167\u5c0di\u5f15\u7528,\u7559\u6700\u7d42\u503c\n    }\n    return nil\n}\n')),(0,l.kt)("h2",{id:"see-also"},"See Also"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://go.dev/blog/defer-panic-and-recover"},"Defer, Panic, and Recover - The Go Blog")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://walkonnet.com/archives/56570"},"Golang \u7684defer\u57f7\u884c\u898f\u5247\u8aaa\u660e - WalkonNet")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://www.gushiciku.cn/pl/pQWu/zh-tw"},"Golang\u4e2d\u7684Defer\u5fc5\u638c\u63e1\u76847\u77e5\u8b58\u9ede - MdEditor"))))}d.isMDXComponent=!0}}]);